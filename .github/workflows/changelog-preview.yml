name: Changelog Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Build craft from source (since changelog command isn't released yet)
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Build Craft
        run: |
          yarn install --frozen-lockfile
          yarn build
          sudo install -m 755 dist/craft /usr/local/bin/craft

      - name: Generate Changelog Preview
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CRAFT_LOG_LEVEL: Warn
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          BASE_REF="${{ github.event.pull_request.base.ref }}"

          # Fetch base branch to compute merge base
          git fetch origin "$BASE_REF"

          # Find the merge base (where PR branched from base)
          MERGE_BASE=$(git merge-base HEAD "origin/$BASE_REF")
          echo "Merge base: $MERGE_BASE"

          # Generate changelog:
          # - From latest tag (default) to merge base (excludes PR commits)
          # - Then inject current PR info from GitHub API
          echo "Running craft changelog --until $MERGE_BASE --pr $PR_NUMBER..."
          CHANGELOG=$(craft changelog --until "$MERGE_BASE" --pr "$PR_NUMBER" 2>&1 || echo "")

          if [[ -z "$CHANGELOG" ]]; then
            CHANGELOG="_No changelog entries will be generated from this PR._"
          fi

          # Build comment body with hidden marker for updates
          COMMENT_BODY="<!-- craft-changelog-preview -->
          ## ðŸ“‹ Changelog Preview

          This is how your changes will appear in the changelog.
          Entries from this PR are highlighted with a left border (blockquote style).

          ---

          ${CHANGELOG}

          ---

          <sub>ðŸ¤– This preview updates automatically when you push changes.</sub>"

          # Save to file for the comment step (handles multiline properly)
          echo "$COMMENT_BODY" > /tmp/changelog-comment.md

          # Find existing comment with our marker
          COMMENT_ID=$(gh api \
            "repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments" \
            --jq '.[] | select(.body | contains("<!-- craft-changelog-preview -->")) | .id' \
            | head -1)

          if [[ -n "$COMMENT_ID" ]]; then
            echo "Updating existing comment $COMMENT_ID..."
            gh api -X PATCH \
              "repos/$GITHUB_REPOSITORY/issues/comments/$COMMENT_ID" \
              -F body=@/tmp/changelog-comment.md
          else
            echo "Creating new comment..."
            gh api -X POST \
              "repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments" \
              -F body=@/tmp/changelog-comment.md
          fi
