name: Changelog Preview

on:
  # Allow this workflow to be called from other repositories
  workflow_call:
    inputs:
      craft-version:
        description: 'Version of Craft to use (tag or "latest")'
        required: false
        type: string
        default: 'latest'

  # Also run on PRs in this repository (for dogfooding)
  # Includes 'edited' and 'labeled' to update when PR title/description/labels change
  pull_request:
    types: [opened, synchronize, reopened, edited, labeled]

permissions:
  pull-requests: write

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # For getsentry/craft repo: build from source to test unreleased changes
      - name: Setup Node.js (for building from source)
        if: github.repository == 'getsentry/craft'
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Build Craft from source
        id: build
        if: github.repository == 'getsentry/craft'
        shell: bash
        run: |
          echo "Building Craft from source..."
          yarn install --frozen-lockfile
          yarn build
          sudo install -m 755 dist/craft /usr/local/bin/craft

      - name: Install Craft from release
        if: github.repository != 'getsentry/craft'
        shell: bash
        env:
          CRAFT_VERSION: ${{ inputs.craft-version || 'latest' }}
        run: |
          if [[ "$CRAFT_VERSION" == "latest" ]]; then
            CRAFT_URL=$(curl -s "https://api.github.com/repos/getsentry/craft/releases/latest" \
              | jq -r '.assets[] | select(.name == "craft") | .browser_download_url')
          else
            CRAFT_URL="https://github.com/getsentry/craft/releases/download/${CRAFT_VERSION}/craft"
          fi
          echo "Installing Craft from: ${CRAFT_URL}"
          sudo curl -sL -o /usr/local/bin/craft "$CRAFT_URL"
          sudo chmod +x /usr/local/bin/craft

      - name: Generate Changelog Preview
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CRAFT_LOG_LEVEL: Warn
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Generate changelog with current PR injected and highlighted
          # Craft fetches PR info from GitHub API, computes merge base from PR's base branch
          echo "Running craft changelog --pr $PR_NUMBER..."
          CHANGELOG=$(craft changelog --pr "$PR_NUMBER" 2>/dev/null || echo "")

          if [[ -z "$CHANGELOG" ]]; then
            CHANGELOG="_No changelog entries will be generated from this PR._"
          fi

          # Build comment body
          read -r -d '' COMMENT_BODY << 'EOF' || true
          <!-- craft-changelog-preview -->
          ## ðŸ“‹ Changelog Preview

          This is how your changes will appear in the changelog.
          Entries from this PR are highlighted with a left border (blockquote style).

          ---

          EOF

          COMMENT_BODY="${COMMENT_BODY}
          ${CHANGELOG}

          ---

          <sub>ðŸ¤– This preview updates automatically when you update the PR.</sub>"

          # Find existing comment with our marker
          COMMENT_ID=$(gh api \
            "repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments" \
            --jq '.[] | select(.body | contains("<!-- craft-changelog-preview -->")) | .id' \
            | head -1)

          if [[ -n "$COMMENT_ID" ]]; then
            echo "Updating existing comment $COMMENT_ID..."
            gh api -X PATCH \
              "repos/$GITHUB_REPOSITORY/issues/comments/$COMMENT_ID" \
              -f body="$COMMENT_BODY"
          else
            echo "Creating new comment..."
            gh api -X POST \
              "repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments" \
              -f body="$COMMENT_BODY"
          fi
