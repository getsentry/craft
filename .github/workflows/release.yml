name: release
on:
  workflow_dispatch:
    inputs:
      version:
        description: Version to release
        required: false
      skip_prepare:
        description: Skip preparation step (assume a release branch is ready)
        required: false
        default: false
      dry_run:
        description: Do not actually cut the release
        required: false
        default: false
jobs:
  release:
    runs-on: ubuntu-latest
    name: "Release a new version"
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.GH_SENTRY_BOT_PAT }}
      - id: set-git-user
        run: |
          git config user.name getsentry-bot
          git config user.email bot@getsentry.com
      - uses: getsentry/craft@master
        if: ${{ !github.event.inputs.skip_prepare }}
        with:
          action: prepare
          version: ${{ github.event.inputs.version }}
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run }}
          GIT_COMMITTER_NAME: getsentry-bot
          GIT_AUTHOR_NAME: getsentry-bot
          EMAIL: bot@getsentry.com
          ZEUS_API_TOKEN: ${{ secrets.ZEUS_API_TOKEN }}
      - uses: getsentry/craft@master
        with:
          action: publish
          version: ${{ github.event.inputs.version }}
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run }}
          GITHUB_API_TOKEN: ${{ secrets.GH_SENTRY_BOT_PAT }}
          ZEUS_API_TOKEN: ${{ secrets.ZEUS_API_TOKEN }}
          DOCKER_USERNAME: 'sentrybuilder'
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          CRAFT_GCS_STORE_CREDS_JSON: ${{ secrets GCS_STORE_CREDS_JSON }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
